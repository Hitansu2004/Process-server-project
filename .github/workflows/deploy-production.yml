name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated: order-service,customer-portal,home-page,etc or "all")'
        required: true
        default: 'all'

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.ezcollab.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Display Deployment Plan
        run: |
          echo "üéØ Production Deployment Plan"
          echo "=============================="
          echo "Server: ${{ secrets.VPS_HOST }}"
          echo "Services: ${{ github.event.inputs.services }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT - Requires approval"
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Build Backend Services
        run: |
          echo "üî® Building backend services..."
          
          SERVICES="${{ github.event.inputs.services }}"
          
          build_backend_service() {
            local service=$1
            echo "üì¶ Building $service..."
            cd backend/$service
            mvn clean package -DskipTests
            echo "‚úÖ Built $service"
            cd ../..
          }
          
          if [ "$SERVICES" = "all" ]; then
            for service in discovery-server api-gateway auth-service user-service tenant-service order-service notification-service; do
              build_backend_service $service
            done
          else
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              service=$(echo $service | xargs)
              case $service in
                "order-service"|"auth-service"|"user-service"|"tenant-service"|"notification-service"|"api-gateway"|"discovery-server")
                  build_backend_service $service
                  ;;
              esac
            done
          fi
      
      - name: Build Frontend Services
        run: |
          echo "üî® Building frontend services..."
          
          SERVICES="${{ github.event.inputs.services }}"
          
          build_frontend_service() {
            local service=$1
            echo "ÔøΩ Building $service..."
            cd frontend/$service
            npm install
            npm run build
            echo "‚úÖ Built $service"
            cd ../..
          }
          
          if [ "$SERVICES" = "all" ]; then
            for service in home-page customer-portal process-server-portal admin-panel super-admin; do
              build_frontend_service $service
            done
          else
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              service=$(echo $service | xargs)
              case $service in
                "home-page"|"customer-portal"|"process-server-portal"|"admin-panel"|"super-admin")
                  build_frontend_service $service
                  ;;
              esac
            done
          fi
      
      - name: Deploy Backend Services
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          echo "üöÄ Deploying backend services..."
          
          SERVICES="${{ github.event.inputs.services }}"
          
          deploy_backend_service() {
            local service=$1
            echo "üì¶ Deploying $service to production..."
            
            # Transfer JAR file
            scp -P $VPS_PORT backend/$service/target/${service}-1.0.0.jar $VPS_USER@$VPS_HOST:/home/ubuntu/apps/$service/
            
            # Restart service
            ssh -p $VPS_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
              export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
              sudo systemctl restart SERVICE_NAME
              echo "‚úÖ Deployed SERVICE_NAME"
          ENDSSH
          }
          
          if [ "$SERVICES" = "all" ]; then
            # Deploy backend services in order (dependencies first)
            for service in discovery-server api-gateway auth-service user-service tenant-service order-service notification-service; do
              echo "Deploying $service..."
              scp -P $VPS_PORT backend/$service/target/${service}-1.0.0.jar $VPS_USER@$VPS_HOST:/home/ubuntu/apps/$service/
              ssh -p $VPS_PORT $VPS_USER@$VPS_HOST "export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin && sudo systemctl restart $service && echo '‚úÖ Deployed $service'"
              sleep 5
            done
          else
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              service=$(echo $service | xargs)
              case $service in
                "order-service"|"auth-service"|"user-service"|"tenant-service"|"notification-service"|"api-gateway"|"discovery-server")
                  echo "Deploying $service..."
                  scp -P $VPS_PORT backend/$service/target/${service}-1.0.0.jar $VPS_USER@$VPS_HOST:/home/ubuntu/apps/$service/
                  ssh -p $VPS_PORT $VPS_USER@$VPS_HOST "export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin && sudo systemctl restart $service && echo '‚úÖ Deployed $service'"
                  sleep 3
                  ;;
              esac
            done
          fi
      
      - name: Deploy Frontend Services
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          echo "üöÄ Deploying frontend services..."
          
          SERVICES="${{ github.event.inputs.services }}"
          
          deploy_frontend_service() {
            local service=$1
            echo "ÔøΩ Deploying $service to production..."
            
            cd frontend/$service
            
            # Create tarball with built files
            tar -czf ${service}-built.tar.gz .next public package.json package-lock.json next.config.js 2>/dev/null || tar -czf ${service}-built.tar.gz .next public package.json next.config.js
            
            # Transfer to server
            scp -P $VPS_PORT ${service}-built.tar.gz $VPS_USER@$VPS_HOST:/home/ubuntu/apps/$service/
            rm ${service}-built.tar.gz
            
            # Deploy on server
            ssh -p $VPS_PORT $VPS_USER@$VPS_HOST << ENDSSH
          export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          cd /home/ubuntu/apps/$service
          tar -xzf ${service}-built.tar.gz
          rm ${service}-built.tar.gz
          npm install --production
          echo "NEXT_PUBLIC_API_URL=https://app.ezcollab.com" > .env.production
          sudo systemctl restart $service
          echo "‚úÖ Deployed $service"
          ENDSSH
            
            cd ../..
          }
          
          if [ "$SERVICES" = "all" ]; then
            for service in home-page customer-portal process-server-portal admin-panel super-admin; do
              deploy_frontend_service $service
              sleep 3
            done
          else
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              service=$(echo $service | xargs)
              case $service in
                "home-page"|"customer-portal"|"process-server-portal"|"admin-panel"|"super-admin")
                  deploy_frontend_service $service
                  sleep 3
                  ;;
              esac
            done
          fi
      
      - name: Verify Deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          echo "üîç Verifying deployment..."
          
          ssh -p $VPS_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
            export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            echo "üìä Service Status:"
            
            for service in discovery-server api-gateway order-service home-page customer-portal; do
              if sudo systemctl is-active --quiet $service 2>/dev/null; then
                echo "‚úÖ $service is running"
              else
                echo "‚ö†Ô∏è  $service is NOT running"
              fi
            done
            
            echo ""
            echo "üåê Testing endpoints..."
            curl -s -o /dev/null -w "Discovery Server: %{http_code}\n" http://localhost:8761 || true
            curl -s -o /dev/null -w "API Gateway: %{http_code}\n" http://localhost:8080/actuator/health || true
            curl -s -o /dev/null -w "Home Page: %{http_code}\n" http://localhost:3001 || true
          ENDSSH
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Production deployment completed successfully!"
          echo ""
          echo "üìä Deployment Details:"
          echo "   Services: ${{ github.event.inputs.services }}"
          echo "   Deployed by: ${{ github.actor }}"
          echo "   Timestamp: $(date)"
          echo ""
          echo "üåê Live at: https://app.ezcollab.com"
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Production deployment failed!"
          echo "Please check the logs above and verify server status"
          exit 1
