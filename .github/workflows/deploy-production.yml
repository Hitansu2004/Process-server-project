name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated: order-service,customer-portal,etc or "all")'
        required: true
        default: 'all'

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.ezcollab.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Display Deployment Plan
        run: |
          echo "üéØ Production Deployment Plan"
          echo "=============================="
          echo "Server: ${{ secrets.VPS_HOST }}"
          echo "Services: ${{ github.event.inputs.services }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT - Requires approval"
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Build Services
        env:
          SERVICES: ${{ github.event.inputs.services }}
        run: |
          echo "üî® Building services in GitHub Actions..."
          
          # Function to build a service
          build_service() {
            local service=$1
            echo "üî® Building $service..."
            
            case $service in
              "home-page"|"customer-portal"|"process-server-portal"|"admin-panel"|"super-admin")
                cd frontend/$service
                npm install
                npm run build
                echo "‚úÖ Built frontend: $service"
                cd ../..
                ;;
                
              "order-service"|"auth-service"|"user-service"|"tenant-service"|"notification-service"|"api-gateway"|"discovery-server")
                cd backend/$service
                mvn clean package -DskipTests
                echo "‚úÖ Built backend: $service"
                cd ../..
                ;;
                
              *)
                echo "‚ö†Ô∏è  Unknown service: $service"
                ;;
            esac
          }
          
          # Parse services to build
          SERVICES="${SERVICES:-all}"
          
          if [ "$SERVICES" = "all" ]; then
            echo "üìã Building ALL services..."
            
            # Build backend services
            for service in discovery-server api-gateway auth-service user-service tenant-service order-service notification-service; do
              build_service $service
            done
            
            # Build frontend services
            for service in home-page customer-portal process-server-portal admin-panel super-admin; do
              build_service $service
            done
          else
            echo "üìã Building selected services: $SERVICES"
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              service=$(echo $service | xargs)  # Trim whitespace
              build_service $service
            done
          fi
          
          echo "‚úÖ All builds completed!"
      
      - name: Deploy Services
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          SERVICES: ${{ github.event.inputs.services }}
        run: |
          echo "üöÄ Deploying BUILT artifacts to production..."
          
          # Function to deploy a single service
          deploy_service() {
            local service=$1
            echo "üì¶ Deploying $service..."
            
            case $service in
              "home-page"|"customer-portal"|"process-server-portal"|"admin-panel"|"super-admin")
                echo "üì¶ Deploying $service frontend (built .next folder)..."
                cd frontend/$service
                
                # Create deployment package with BUILT files
                tar -czf ${service}-built.tar.gz \
                  .next \
                  public \
                  package.json \
                  package-lock.json \
                  next.config.js \
                  || true
                
                # Transfer to server
                scp -P $VPS_PORT ${service}-built.tar.gz $VPS_USER@$VPS_HOST:/home/ubuntu/apps/$service/
                rm ${service}-built.tar.gz
                
                # Deploy on server
                ssh -p $VPS_PORT $VPS_USER@$VPS_HOST <<ENDSSH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
cd /home/ubuntu/apps/$service

# Extract built files
tar -xzf ${service}-built.tar.gz
rm ${service}-built.tar.gz

# Install ONLY production dependencies (no devDependencies)
npm install --production

# Create production env file
echo "NEXT_PUBLIC_API_URL=https://app.ezcollab.com" > .env.production

# Restart service
sudo systemctl restart $service

echo "‚úÖ Deployed $service"
ENDSSH
                cd ../..
                ;;
                
              "order-service"|"auth-service"|"user-service"|"tenant-service"|"notification-service"|"api-gateway"|"discovery-server")
                echo "üì¶ Deploying $service backend (JAR file)..."
                cd backend/$service
                
                # Transfer BUILT JAR to server
                scp -P $VPS_PORT target/${service}-1.0.0.jar $VPS_USER@$VPS_HOST:/home/ubuntu/apps/$service/
                
                # Restart service
                ssh -p $VPS_PORT $VPS_USER@$VPS_HOST <<ENDSSH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
sudo systemctl restart $service
echo "‚úÖ Deployed $service"
ENDSSH
                cd ../..
                ;;
                
              *)
                echo "‚ö†Ô∏è  Unknown service: $service"
                ;;
            esac
          }
          
          # Parse services to deploy
          SERVICES="${SERVICES:-all}"
          
          if [ "$SERVICES" = "all" ]; then
            echo "üìã Deploying ALL services..."
            
            # Deploy backend services (order matters for dependencies)
            for service in discovery-server api-gateway auth-service user-service tenant-service order-service notification-service; do
              deploy_service $service
              sleep 5  # Wait between services for stability
            done
            
            # Deploy frontend services
            for service in home-page customer-portal process-server-portal admin-panel super-admin; do
              deploy_service $service
              sleep 3
            done
          else
            echo "üìã Deploying selected services: $SERVICES"
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              service=$(echo $service | xargs)  # Trim whitespace
              deploy_service $service
              sleep 3
            done
          fi
          
          echo "‚úÖ Deployment completed!"
      
      - name: Verify Deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          SERVICES: ${{ github.event.inputs.services }}
        run: |
          echo "üîç Verifying deployment..."
          
          ssh -p $VPS_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
            export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            echo "üìä Service Status:"
            
            # Check common services
            for service in discovery-server api-gateway order-service home-page customer-portal; do
              if sudo systemctl is-active --quiet $service 2>/dev/null; then
                echo "‚úÖ $service is running"
              else
                echo "‚ö†Ô∏è  $service is NOT running"
              fi
            done
            
            echo ""
            echo "üåê Testing endpoints..."
            curl -s -o /dev/null -w "Discovery Server: %{http_code}\n" http://localhost:8761 || true
            curl -s -o /dev/null -w "API Gateway: %{http_code}\n" http://localhost:8080/actuator/health || true
            curl -s -o /dev/null -w "Home Page: %{http_code}\n" http://localhost:3001 || true
            
            echo ""
            echo "‚úÖ Deployment verification complete"
          ENDSSH
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Production deployment completed successfully!"
          echo ""
          echo "üìä Deployment Details:"
          echo "   Services: ${{ github.event.inputs.services }}"
          echo "   Deployed by: ${{ github.actor }}"
          echo "   Timestamp: $(date)"
          echo ""
          echo "üåê Live at: https://app.ezcollab.com"
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Production deployment failed!"
          echo "Please check the logs above and verify server status"
          exit 1
